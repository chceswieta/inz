<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Compiler</title>
    <link href="https://pagecdn.io/lib/codemirror/5.62.3/codemirror.css" rel="stylesheet">
    <script src="https://pagecdn.io/lib/codemirror/5.62.3/codemirror.js"></script>
    <script src="https://pagecdn.io/lib/codemirror/5.62.3/addon/edit/closebrackets.min.js"></script>
    <script src="https://unpkg.com/wast-loader@1.11.1/lib/index.js"></script>
    <style>
        body {
            background: #333333;
        }
        .error-line {
            background: red!important;
            color: white!important;
        }
        .compilation-error {
            font-size: 0.65rem;
            padding: 4px;
            color: red;
        }
        .editors {
            display: flex;
            flex-flow: row nowrap;
            justify-content: space-between;
            width: 100%;
        }
        .editors > * {
            width: 45%;
        }
    </style>
</head>

<body>
    <div class="editors">
        <textarea id="input" rows="30" style="resize:none;"></textarea>
        <textarea id="output" rows="30" disabled style="resize:none;"></textarea><br>
    </div>

    <button onclick="compile()">Compile</button>
    <script>
        let input = CodeMirror.fromTextArea(document.getElementById('input'), {
            lineNumbers: true,
            lineWrapping: true,
            autoCloseBrackets: true
        });
        let output = CodeMirror.fromTextArea(document.getElementById('output'), {
            lineNumbers: true,
            lineWrapping: true,
            readOnly: true
        });
        let error = null
        input.setValue("def main() {\n\twrite 11\n}")
        function compile() {
            let code = input.getValue()
            if (error !== null) {
                input.removeLineClass(error.line, "text", "error-line")
                input.removeLineWidget(error.widget)
            }

            fetch('/compile', {
                method: 'POST',
                body: code,
            }).then(
                (response) => ({status: response.status, text: response.text()})
            ).then(
                (obj) => {
                    obj.text.then(
                        (text) => {
                            if (obj.status === 400) {
                                console.log(text)

                                let tokens = text.split(":")
                                let element = document.createElement("div")
                                element.appendChild(document.createTextNode("ðŸ¡± " + tokens[1]))
                                element.className = "compilation-error"
                                error = {
                                    line: input.addLineClass(tokens[0] - 1, "text", "error-line"),
                                    widget: input.addLineWidget(tokens[0] - 1, element)
                                }
                            }
                            output.setValue(text)
                        }
                    )
                }
            )
        }

        function run() {
            let code = output.getValue()
            let importObject = {
                imports: {write: (arg) => console.log(arg)}
            }

            WebAssembly.instantiateStreaming(fetch('/run', {
                method: 'POST',
                body: code,
                response_type: 'application/wasm'
            }), importObject).then(obj => obj.instance.exports.main())
        }
    </script>
</body>

</html>