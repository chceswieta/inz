<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Compiler</title>
    <link href="https://pagecdn.io/lib/codemirror/5.61.0/codemirror.css" rel="stylesheet">
    <script src="https://pagecdn.io/lib/codemirror/5.61.0/codemirror.js"></script>
    <script src="https://unpkg.com/wast-loader@1.11.1/lib/index.js"></script>
    <style>
        body {
            background: #333333;
        }
        .compilation-error {
            color: red;
        }
        .editors {
            display: flex;
            flex-flow: row nowrap;
            justify-content: space-between;
            width: 100%;
        }
        .editors > * {
            width: 45%;
        }
    </style>
</head>

<body>
    <div class="editors">
        <textarea id="input" rows="30" style="resize:none;"></textarea>
        <textarea id="output" rows="30" disabled style="resize:none;"></textarea><br>
    </div>

    <button onclick="compile()">Compile</button>
    <script>
        let input = CodeMirror.fromTextArea(document.getElementById('input'), {
            lineNumbers: true,
            lineWrapping: true
        });
        let output = CodeMirror.fromTextArea(document.getElementById('output'), {
            lineNumbers: true,
            lineWrapping: true,
            readOnly: true
        });
        let errors = []
        input.setValue("def main() { write 11 }")
        function compile() {
            let code = input.getValue()
            errors.forEach((widget) => input.removeLineWidget(widget))

            fetch('/compile', {
                method: 'POST',
                body: code,
            }).then(
                (response) => ({status: response.status, text: response.text()})
            ).then(
                (obj) => {
                    obj.text.then(
                        (text) => {
                            if (obj.status === 400) {
                                let tokens = text.split(":")
                                let element = document.createElement("div")
                                element.appendChild(document.createTextNode(tokens[1]))
                                element.className = "compilation-error"
                                errors.push(input.addLineWidget(tokens[0] - 1, element))
                            }
                            output.setValue(text)
                        }
                    )
                }
            )
        }

        function run() {
            let code = output.getValue()
            let importObject = {
                imports: {write: (arg) => console.log(arg)}
            }

            WebAssembly.instantiateStreaming(fetch('/run', {
                method: 'POST',
                body: code,
                response_type: 'application/wasm'
            }), importObject).then(obj => obj.instance.exports.main())
        }
    </script>
</body>

</html>